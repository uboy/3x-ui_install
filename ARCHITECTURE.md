# Архитектура проекта "Aegis VPN Toolbox"

## Основная концепция
Проект представляет собой модульный bash-скрипт для развертывания и настройки различных VPN-решений и прокси-панелей на сервере Ubuntu 24.04. 
Главная цель — предоставить пользователю удобный интерактивный интерфейс выбора компонентов и обеспечить безопасную, расширяемую установку.

## Структура директорий
```text
.
├── install.sh            # Главный исполняемый файл (оркестратор)
├── lib/                  # Ядро: общие функции и библиотеки
│   ├── common.sh         # Логирование, обработка ошибок, утилиты массивов
│   ├── state.sh          # Управление состоянием (сохранение/загрузка переменных)
│   ├── utils.sh          # Генерация паролей, валидация IP/портов
│   ├── ui.sh             # Отрисовка меню, интерактивные промпты (dialog/whiptail/read)
│   ├── cert.sh           # Управление SSL-сертификатами (Let's Encrypt)
│   └── firewall.sh       # Управление правилами UFW (открытие/закрытие портов)
├── modules/              # Независимые модули установки компонентов
│   ├── base.sh           # Системные пакеты, настройка ОС
│   ├── hardening.sh      # Настройка SSH, fail2ban, создание пользователя
│   ├── docker.sh         # Установка Docker и Compose
│   ├── xui.sh            # Установка и настройка 3x-ui (Docker)
│   ├── openvpn.sh        # Установка OpenVPN
│   ├── openconnect.sh    # Установка OpenConnect (ocserv)
│   └── amnezia.sh        # Установка Amnezia VPN (контейнерная сборка)
└── config/               # Шаблоны конфигурационных файлов (опционально)
    └── ...
```

## Жизненный цикл (Execution Flow)
1. **Инициализация**: Запуск `install.sh`. Подгрузка библиотек из `lib/`.
2. **Загрузка состояния**: `load_install_state` читает сохраненные данные из `/root/.vpn-install.state` (если запуск не первый).
3. **UI / Промпты**: Скрипт спрашивает пользователя (через `ui.sh`), что устанавливать (3x-ui, OpenVPN, OpenConnect, Amnezia), запрашивает домены, порты, email.
4. **Сохранение состояния**: Выбор и введенные данные сохраняются.
5. **Pre-flight Check**: Валидация введенных данных (домены, доступность портов).
6. **Базовая настройка**: `modules/base.sh` (пакеты) -> `modules/hardening.sh` (безопасность) -> `modules/docker.sh`.
7. **Исполнение модулей**: Поочередный вызов `module_<name>_install` и `module_<name>_configure` для выбранных компонентов.
8. **Пост-конфигурация**: Настройка UFW, генерация финального отчета с доступами.

## Стандарты модулей
Каждый модуль должен экспортировать 2-3 основные функции:
- `module_<name>_install` — скачивание пакетов/образов, раскладка файлов.
- `module_<name>_configure` — применение конфигурации, генерация ключей/сертификатов.
- *(Опционально)* `module_<name>_status` — проверка работоспособности.

Модули не должны напрямую менять настройки других модулей. Для открытия портов они вызывают функцию из `lib/firewall.sh`.
