# План задач (Декомпозиция)

## Фаза 1: Ядро и Инфраструктура (Foundation)
- [x] **1.1** Создать модульную структуру директорий (`lib/`, `modules/`).
- [x] **1.2** Реализовать базовое логирование и обработку ошибок (`lib/common.sh`).
- [x] **1.3** Реализовать механизм управления состоянием (сохранение/восстановление переменных) (`lib/state.sh`).
- [x] **1.4** Написать базовые утилиты (генерация паролей, валидация IP) (`lib/utils.sh`).
- [ ] **1.5** Интерактивный UI. Перевести `ui.sh` на использование `whiptail` или `dialog` (или улучшить консольный ввод) для красивого интерфейса выбора.
- [ ] **1.6** Модуль Firewall: создать централизованное управление UFW.
- [ ] **1.7** Модуль Certbot: вынести логику получения Let's Encrypt в отдельный модуль.

## Фаза 2: Базовая система и Безопасность
- [ ] **2.1** Модуль `base.sh`: проверка ОС (Ubuntu 24.04), установка зависимостей.
- [ ] **2.2** Модуль `docker.sh`: идемпотентная установка Docker и Docker Compose.
- [ ] **2.3** Модуль `hardening.sh`: перенос логики настройки SSH (генерация юзера, отключение root, смена порта) и Fail2Ban из оригинального скрипта.

## Фаза 3: Портирование функционала 3x-ui
- [ ] **3.1** Установка: Раскладка docker-compose, запуск контейнера.
- [ ] **3.2** Настройка API: Авторизация через API, смена дефолтных кредов, настройка портов.
- [ ] **3.3** Настройка SSL: Привязка сертификатов к панели.
- [ ] **3.4** Авто-создание Inbound: Создание подключения VLESS/Reality через API панели.

## Фаза 4: Новые VPN протоколы
- [ ] **4.1 OpenVPN**
  - Интеграция установки (напр. скрипт Nyr или docker-версия).
  - Настройка автоматической генерации первого клиентского профиля (`.ovpn`).
- [ ] **4.2 OpenConnect (AnyConnect)**
  - Установка пакета `ocserv`.
  - Генерация серверных сертификатов (через Certbot или self-signed).
  - Настройка маршрутизации (NAT/iptables).
  - Утилита для добавления пользователей.
- [ ] **4.3 Amnezia VPN**
  - Анализ способа развертывания (скорее всего Docker / AmneziaWG).
  - Подготовка compose-файла и запуск.
  - Вывод конфигурации для клиента.

## Фаза 5: Финализация
- [ ] **5.1** Сведение всего в единый флоу в `install.sh`.
- [ ] **5.2** Разработка итогового экрана с выгрузкой всех доступов, паролей и ссылок.
- [ ] **5.3** Тестирование идемпотентности (повторный запуск скрипта не должен ничего ломать).
